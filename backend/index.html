<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Fashion Finder</title>
    <style>
      :root {
        --primary-color: #222;
        --secondary-color: #f8f8f8;
        --accent-color: #e63946;
        --text-color: #333;
        --card-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        --hover-shadow: 0 8px 30px rgba(0, 0, 0, 0.15);
        --transition: all 0.3s ease;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: 'Helvetica Neue', Arial, sans-serif;
      }

      body {
        background-color: #f9f9f9;
        color: var(--text-color);
        padding: 20px;
        line-height: 1.6;
      }

      header {
        text-align: center;
        padding: 40px 0;
        margin-bottom: 20px;
        position: relative;
      }

      h1 {
        font-size: 2.5rem;
        font-weight: 300;
        letter-spacing: 1px;
        margin-bottom: 10px;
        text-transform: uppercase;
      }

      .search-summary {
        font-size: 1.1rem;
        color: #666;
        font-style: italic;
        margin-bottom: 20px;
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
      }

      .products-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 30px;
        padding: 20px 0;
      }

      .product-card {
        background: white;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: var(--card-shadow);
        transition: var(--transition);
        height: 100%;
        display: flex;
        flex-direction: column;
        cursor: pointer;
        position: relative;
      }

      .product-card:hover {
        transform: translateY(-5px);
        box-shadow: var(--hover-shadow);
      }

      .product-link {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 1;
      }

      .product-image {
        height: 320px;
        overflow: hidden;
        position: relative;
      }

      .product-image img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transition: transform 0.5s ease;
      }

      .product-card:hover .product-image img {
        transform: scale(1.05);
      }

      .product-info {
        padding: 20px;
        flex-grow: 1;
        display: flex;
        flex-direction: column;
      }

      .product-name {
        font-size: 1rem;
        font-weight: 500;
        margin-bottom: 8px;
        line-height: 1.3;
      }

      .product-price {
        font-size: 1.2rem;
        font-weight: 600;
        margin: 10px 0;
      }

      .product-attributes {
        margin-top: auto;
        padding-top: 15px;
        border-top: 1px solid #eee;
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
      }

      .attribute {
        background: #f0f0f0;
        color: #555;
        font-size: 0.8rem;
        padding: 4px 10px;
        border-radius: 20px;
        display: inline-block;
      }

      .availability {
        font-size: 0.85rem;
        margin-top: 10px;
        color: #666;
      }

      .available {
        color: #2e7d32;
      }

      .unavailable {
        color: #c62828;
      }

      @media (max-width: 1200px) {
        .products-grid {
          grid-template-columns: repeat(3, 1fr);
        }
      }

      @media (max-width: 900px) {
        .products-grid {
          grid-template-columns: repeat(2, 1fr);
        }
      }

      @media (max-width: 600px) {
        .products-grid {
          grid-template-columns: 1fr;
        }

        header {
          padding: 20px 0;
        }

        h1 {
          font-size: 1.8rem;
        }
      }

      .filters {
        display: flex;
        gap: 15px;
        margin-bottom: 20px;
        flex-wrap: wrap;
        justify-content: center;
      }

      .filter-button {
        background: white;
        border: 1px solid #ddd;
        border-radius: 30px;
        padding: 8px 16px;
        font-size: 0.9rem;
        cursor: pointer;
        transition: var(--transition);
      }

      .filter-button:hover,
      .filter-button.active {
        background: var(--primary-color);
        color: white;
        border-color: var(--primary-color);
      }

      /* Upload section styles */
      .upload-section {
        background: white;
        border-radius: 8px;
        box-shadow: var(--card-shadow);
        padding: 30px;
        text-align: center;
        margin-bottom: 30px;
      }

      .upload-section h2 {
        font-size: 1.5rem;
        font-weight: 400;
        margin-bottom: 15px;
      }

      .upload-area {
        border: 2px dashed #ddd;
        border-radius: 8px;
        padding: 30px;
        margin: 15px 0;
        transition: var(--transition);
        position: relative;
      }

      .upload-area:hover {
        border-color: var(--primary-color);
      }

      .upload-area input[type='file'] {
        position: absolute;
        width: 100%;
        height: 100%;
        top: 0;
        left: 0;
        opacity: 0;
        cursor: pointer;
      }

      .preview-container {
        display: none;
        margin: 20px auto;
        max-width: 300px;
      }

      .preview-container img {
        max-width: 100%;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      .upload-button {
        background: var(--primary-color);
        color: white;
        border: none;
        border-radius: 30px;
        padding: 12px 30px;
        font-size: 1rem;
        cursor: pointer;
        transition: var(--transition);
        margin-top: 20px;
      }

      .upload-button:hover {
        background: #000;
        transform: translateY(-2px);
      }

      .upload-button:disabled {
        background: #ccc;
        cursor: not-allowed;
        transform: none;
      }

      .error-message {
        color: #e63946;
        margin-top: 15px;
        display: none;
      }

      .loading-indicator {
        display: none;
        margin: 20px auto;
      }

      .spinner {
        border: 4px solid rgba(0, 0, 0, 0.1);
        border-radius: 50%;
        border-top: 4px solid var(--primary-color);
        width: 30px;
        height: 30px;
        animation: spin 1s linear infinite;
        margin: 0 auto;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .clothing-analysis {
        background: white;
        border-radius: 8px;
        box-shadow: var(--card-shadow);
        padding: 25px;
        margin-bottom: 30px;
        display: none;
      }

      .clothing-analysis h2 {
        font-size: 1.5rem;
        font-weight: 400;
        margin-bottom: 15px;
        border-bottom: 1px solid #eee;
        padding-bottom: 10px;
      }

      .analysis-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 15px;
      }

      .analysis-item {
        background: #f9f9f9;
        border-radius: 8px;
        padding: 15px;
      }

      .analysis-label {
        font-weight: 500;
        color: #666;
        font-size: 0.9rem;
        margin-bottom: 5px;
      }

      .analysis-value {
        font-size: 1.1rem;
      }

      .results-title {
        text-align: center;
        margin: 40px 0 20px;
        font-weight: 300;
        font-size: 2rem;
      }

      .no-results {
        text-align: center;
        padding: 50px 0;
        color: #666;
        font-style: italic;
        display: none;
      }
    </style>
  </head>
  <body>
    <header>
      <div class="container">
        <h1>Fashion Finder</h1>
        <p class="search-summary">
          Upload your clothing image to find similar items
        </p>
      </div>
    </header>

    <div class="container">
      <!-- Upload Section -->
      <div class="upload-section">
        <h2>Find Similar Clothing Items</h2>
        <p>
          Upload an image of clothing you like and we'll find similar items for
          you
        </p>

        <div class="upload-area">
          <input
            type="file"
            id="fileInput"
            accept="image/png, image/jpeg, image/jpg, image/gif, image/webp"
          />
          <p>Drag & drop your image here or click to browse</p>
          <p style="font-size: 0.9rem; color: #666; margin-top: 10px">
            Supported formats: JPG, PNG, GIF, WEBP
          </p>
        </div>

        <div class="preview-container">
          <img id="imagePreview" src="" alt="Image preview" />
        </div>

        <button id="uploadButton" class="upload-button" disabled>
          Find Similar Items
        </button>

        <div class="error-message" id="errorMessage"></div>

        <div class="loading-indicator">
          <div class="spinner"></div>
          <p>Analyzing your image...</p>
        </div>
      </div>

      <!-- Clothing Analysis Section -->
      <div class="clothing-analysis" id="clothingAnalysis">
        <h2>Clothing Analysis</h2>
        <div class="analysis-grid" id="analysisGrid">
          <!-- Analysis items will be inserted here -->
        </div>
      </div>

      <!-- Results Section -->
      <h2 class="results-title" id="resultsTitle" style="display: none">
        Similar Items
      </h2>

      <div class="filters" id="filterContainer" style="display: none">
        <!-- Filters will be added dynamically -->
      </div>

      <div class="no-results" id="noResults">
        No matching products found. Please try a different image.
      </div>

      <div class="products-grid" id="productsGrid">
        <!-- Product cards will be generated here -->
      </div>
    </div>

    <script>
      document.addEventListener('DOMContentLoaded', function () {
        // Elements
        const fileInput = document.getElementById('fileInput');
        const imagePreview = document.getElementById('imagePreview');
        const previewContainer = document.querySelector('.preview-container');
        const uploadButton = document.getElementById('uploadButton');
        const errorMessage = document.getElementById('errorMessage');
        const loadingIndicator = document.querySelector('.loading-indicator');
        const clothingAnalysis = document.getElementById('clothingAnalysis');
        const analysisGrid = document.getElementById('analysisGrid');
        const productsGrid = document.getElementById('productsGrid');
        const resultsTitle = document.getElementById('resultsTitle');
        const filterContainer = document.getElementById('filterContainer');
        const noResults = document.getElementById('noResults');
        const uploadArea = document.querySelector('.upload-area');

        // Handle file selection
        fileInput.addEventListener('change', function () {
          const file = this.files[0];
          if (file) {
            if (!file.type.match('image.*')) {
              showError(
                'Please select a valid image file (JPEG, PNG, GIF, WEBP)'
              );
              resetPreview();
              return;
            }

            const reader = new FileReader();
            reader.onload = function (e) {
              imagePreview.src = e.target.result;
              previewContainer.style.display = 'block';
              uploadButton.disabled = false;
              errorMessage.style.display = 'none';
            };
            reader.readAsDataURL(file);
          } else {
            resetPreview();
          }
        });

        // Handle drag and drop
        uploadArea.addEventListener('dragover', function (e) {
          e.preventDefault();
          this.style.borderColor = '#000';
        });

        uploadArea.addEventListener('dragleave', function () {
          this.style.borderColor = '#ddd';
        });

        uploadArea.addEventListener('drop', function (e) {
          e.preventDefault();
          this.style.borderColor = '#ddd';

          if (e.dataTransfer.files.length) {
            const file = e.dataTransfer.files[0];
            if (file.type.match('image.*')) {
              fileInput.files = e.dataTransfer.files;

              const reader = new FileReader();
              reader.onload = function (e) {
                imagePreview.src = e.target.result;
                previewContainer.style.display = 'block';
                uploadButton.disabled = false;
                errorMessage.style.display = 'none';
              };
              reader.readAsDataURL(file);
            } else {
              showError(
                'Please select a valid image file (JPEG, PNG, GIF, WEBP)'
              );
            }
          }
        });

        // Handle upload button click
        uploadButton.addEventListener('click', function () {
          if (!fileInput.files.length) {
            showError('Please select an image first');
            return;
          }

          // Hide previous results if any
          resetResults();

          // Show loading indicator
          loadingIndicator.style.display = 'block';
          uploadButton.disabled = true;

          // Prepare form data
          const formData = new FormData();
          formData.append('image', fileInput.files[0]);

          // Log for debugging
          console.log('About to send request to backend');
          console.log('File selected:', fileInput.files[0].name);

          // Use the ABSOLUTE URL to your backend
          const backendUrl = 'http://127.0.0.1:5001/api/fashion/find';

          // Send image to backend with explicit mode
          fetch(backendUrl, {
            method: 'POST',
            body: formData,
            mode: 'cors', // Explicitly set CORS mode
          })
            .then((response) => {
              console.log('Response status:', response.status);
              if (!response.ok) {
                return response.json().then((data) => {
                  throw new Error(data.message || 'Server error occurred');
                });
              }
              return response.json();
            })
            .then((data) => {
              console.log('Response data:', data);
              // Hide loading indicator
              loadingIndicator.style.display = 'none';

              // Check for successful response
              if (!data.status) {
                throw new Error(data.message || 'Failed to process image');
              }

              // Display clothing analysis
              displayClothingAnalysis(data.clothing_attributes || data);

              // Display products if available
              console.log('Products data:', data.items);
              if (data.items && data.items.length > 0) {
                displayProducts(data.items);

                // Show filters
                createFilters(data.items);
                filterContainer.style.display = 'flex';

                // Show results title
                resultsTitle.style.display = 'block';
              } else {
                // Show no results message
                noResults.style.display = 'block';
              }

              // Re-enable upload button
              uploadButton.disabled = false;
            })
            .catch((error) => {
              // Hide loading indicator
              loadingIndicator.style.display = 'none';

              // Show detailed error in console
              console.error('Error details:', error);
              console.error('Error message:', error.message);
              console.error('Error name:', error.name);

              // Show error message to user
              showError(error.message || 'An error occurred');

              // Re-enable upload button
              uploadButton.disabled = false;
            });
        });

        // Helper functions
        function resetPreview() {
          imagePreview.src = '';
          previewContainer.style.display = 'none';
          uploadButton.disabled = true;
        }

        function resetResults() {
          clothingAnalysis.style.display = 'none';
          analysisGrid.innerHTML = '';
          productsGrid.innerHTML = '';
          resultsTitle.style.display = 'none';
          filterContainer.style.display = 'none';
          filterContainer.innerHTML = '';
          noResults.style.display = 'none';
        }

        function showError(message) {
          errorMessage.textContent = message;
          errorMessage.style.display = 'block';
        }

        function displayClothingAnalysis(data) {
          // Clear previous analysis
          analysisGrid.innerHTML = '';

          // Handle different response formats
          let clothingType = '';
          let attributes = {};

          if (data.clothing_type) {
            clothingType = data.clothing_type;
            attributes = data.attributes || {};
          } else if (data.attributes) {
            clothingType = data.attributes.clothing_type || '';
            attributes = data.attributes || {};
          }

          // Add clothing type
          if (clothingType) {
            addAnalysisItem('Item Type', clothingType);
          }

          // Add other attributes
          for (const [key, value] of Object.entries(attributes)) {
            if (key !== 'clothing_type' && value) {
              // Format the key (capitalize first letter, replace underscores with spaces)
              const formattedKey =
                key.charAt(0).toUpperCase() + key.slice(1).replace(/_/g, ' ');
              addAnalysisItem(formattedKey, value);
            }
          }

          // Show analysis section
          clothingAnalysis.style.display = 'block';
        }

        function addAnalysisItem(label, value) {
          const item = document.createElement('div');
          item.className = 'analysis-item';

          const labelElement = document.createElement('div');
          labelElement.className = 'analysis-label';
          labelElement.textContent = label;

          const valueElement = document.createElement('div');
          valueElement.className = 'analysis-value';
          valueElement.textContent = value;

          item.appendChild(labelElement);
          item.appendChild(valueElement);

          analysisGrid.appendChild(item);
        }

        function displayProducts(products) {
          // Clear previous products
          productsGrid.innerHTML = '';
          console.log(
            'productsGrid exists:',
            !!document.getElementById('productsGrid')
          );
          products.forEach((product) => {
            // Create product card
            const card = document.createElement('div');
            card.className = 'product-card';

            // Set data attributes for filtering
            if (product.attributes) {
              if (product.attributes.color) {
                card.setAttribute(
                  'data-color',
                  product.attributes.color.toLowerCase()
                );
              }
              if (product.attributes.length) {
                card.setAttribute(
                  'data-length',
                  product.attributes.length.toLowerCase()
                );
              }
              if (product.attributes.style) {
                card.setAttribute(
                  'data-style',
                  product.attributes.style.toLowerCase()
                );
              }
              if (product.attributes.material) {
                card.setAttribute(
                  'data-material',
                  product.attributes.material.toLowerCase()
                );
              }
            }

            // Check if product is available
            const isAvailable = product.availability
              ? product.availability.toLowerCase().includes('available')
              : true;
            const availabilityClass = isAvailable ? 'available' : 'unavailable';

            // Check if image URL is video format (m3u8)
            let imageUrl = product.image_url || '';
            if (imageUrl.includes('.m3u8')) {
              imageUrl =
                'https://static.zara.net/assets/public/placeholder.jpg';
            }

            // Build card HTML
            card.innerHTML = `
              <a href="${
                product.product_url || '#'
              }" class="product-link" target="_blank" rel="noopener noreferrer"></a>
              <div class="product-image">
                <img src="${imageUrl}" alt="${product.name || 'Product'}" 
                  onerror="this.onerror=null; this.src='https://via.placeholder.com/400x320?text=Image+Unavailable';">
              </div>
              <div class="product-info">
                <h3 class="product-name">${product.name || 'Product'}</h3>
                <p class="product-price">${product.price || ''}</p>
                <div class="product-attributes">
                  ${
                    product.attributes?.color
                      ? `<span class="attribute">${product.attributes.color}</span>`
                      : ''
                  }
                  ${
                    product.attributes?.length
                      ? `<span class="attribute">${product.attributes.length}</span>`
                      : ''
                  }
                  ${
                    product.attributes?.material
                      ? `<span class="attribute">${product.attributes.material}</span>`
                      : ''
                  }
                  ${
                    product.attributes?.style
                      ? `<span class="attribute">${product.attributes.style}</span>`
                      : ''
                  }
                </div>
                ${
                  product.availability
                    ? `<p class="availability ${availabilityClass}">${product.availability}</p>`
                    : ''
                }
              </div>
            `;

            productsGrid.appendChild(card);
          });
        }

        function createFilters(products) {
          // Clear existing filters
          filterContainer.innerHTML = '';

          // Add "All" filter
          addFilter('All', true);

          // Collect unique values for different attributes
          const colors = new Set();
          const lengths = new Set();

          products.forEach((product) => {
            if (product.attributes) {
              if (product.attributes.color) {
                colors.add(product.attributes.color.toLowerCase());
              }
              if (product.attributes.length) {
                lengths.add(product.attributes.length.toLowerCase());
              }
            }
          });

          // Add length filters (mini, midi, maxi)
          ['mini', 'midi', 'maxi'].forEach((length) => {
            if (lengths.has(length)) {
              addFilter(length.charAt(0).toUpperCase() + length.slice(1));
            }
          });

          // Add color filters (black + others)
          if (colors.has('black')) {
            addFilter('Black');
          }

          // Add "Colored" filter if there are non-black colors
          if (colors.size > 1 || (colors.size === 1 && !colors.has('black'))) {
            addFilter('Colored');
          }
        }

        function addFilter(text, isActive = false) {
          const button = document.createElement('button');
          button.className = 'filter-button' + (isActive ? ' active' : '');
          button.textContent = text;

          button.addEventListener('click', function () {
            // Update active state
            document.querySelectorAll('.filter-button').forEach((btn) => {
              btn.classList.remove('active');
            });
            this.classList.add('active');

            // Apply filter
            const filterValue = this.textContent.trim().toLowerCase();
            const cards = document.querySelectorAll('.product-card');

            cards.forEach((card) => {
              // Show all if "All" is selected
              if (filterValue === 'all') {
                card.style.display = 'block';
                return;
              }

              // Filter by length
              if (
                filterValue === 'mini' ||
                filterValue === 'midi' ||
                filterValue === 'maxi'
              ) {
                if (
                  card.getAttribute('data-length') &&
                  card.getAttribute('data-length').includes(filterValue)
                ) {
                  card.style.display = 'block';
                } else {
                  card.style.display = 'none';
                }
              }

              // Filter by color
              if (filterValue === 'black') {
                if (
                  card.getAttribute('data-color') &&
                  card.getAttribute('data-color').includes('black')
                ) {
                  card.style.display = 'block';
                } else {
                  card.style.display = 'none';
                }
              }

              // Show all non-black for "Colored" filter
              if (filterValue === 'colored') {
                if (
                  card.getAttribute('data-color') &&
                  !card.getAttribute('data-color').includes('black')
                ) {
                  card.style.display = 'block';
                } else {
                  card.style.display = 'none';
                }
              }
            });
          });

          filterContainer.appendChild(button);
        }
      });
    </script>
  </body>
</html>
